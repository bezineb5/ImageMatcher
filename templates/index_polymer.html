<!doctype html>
<html>

<head>

  <title>ImageMatcher</title>

  <style>
    html, body {
      display: block;
      height: 100%;
      font-family: 'RobotoDraft', sans-serif;
    }
  </style>

  <meta name="viewport"
    content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <script src="{{url_for('static', filename='bower_components/webcomponentsjs/webcomponents-lite.min.js')}}"></script>

  <link rel="import" href="{{url_for('static', filename='bower_components/font-roboto/roboto.html')}}">

  <link rel="import" href="{{url_for('static', filename='bower_components/paper-toolbar/paper-toolbar.html')}}">
  <link rel="import" href="{{url_for('static', filename='bower_components/paper-header-panel/paper-header-panel.html')}}">

  <link rel="import" href="{{url_for('static', filename='bower_components/iron-ajax/iron-ajax.html')}}">
  <link rel="import" href="{{url_for('static', filename='bower_components/iron-ajax/iron-request.html')}}">
  <link rel="import" href="{{url_for('static', filename='bower_components/iron-image/iron-image.html')}}">
  <link rel="import" href="{{url_for('static', filename='bower_components/iron-list/iron-list.html')}}">

  <link rel="import" href="{{url_for('static', filename='bower_components/iron-icons/iron-icons.html')}}">
  <link rel="import" href="{{url_for('static', filename='bower_components/paper-fab/paper-fab.html')}}">

  <link rel="import" href="{{url_for('static', filename='bower_components/paper-dialog/paper-dialog.html')}}">
  <link rel="import" href="{{url_for('static', filename='bower_components/paper-button/paper-button.html')}}">
  <link rel="import" href="{{url_for('static', filename='bower_components/paper-icon-button/paper-icon-button.html')}}">

  <link rel="import" href="{{url_for('static', filename='components/image-card.html')}}">

  <link rel="import" href="{{url_for('static', filename='bower_components/jsonymer/jsonymer-editor.html')}}">
  <link rel="import" href="{{url_for('static', filename='bower_components/prism-js/prism-js.html')}}">
</head>
{% raw %}
<body unresolved fullbleed vertical layout>
<dom-module id="root-element">
  <template>

  <iron-ajax
      auto
      id="ajax-reference"
      url="api/1.0/references/"
      handleAs="json"
      on-response="handleResponse"></iron-ajax>
  <iron-request id="xhr"></iron-request>

  <paper-header-panel id="hPanel" flex>
    <paper-toolbar >
      <div class="title">ImageMatcher</div>
      <paper-icon-button icon="search" on-tap="tapSearchHandler"></paper-icon-button>
      <paper-icon-button icon="refresh" on-tap="tapRefreshHandler"></paper-icon-button>
    </paper-toolbar>

    <iron-list items="[[data]]" as="item">
      <template>
        <image-card>
          <iron-image sizing="cover" src="[[item.thumbnail_url]]" preload></iron-image>
          <h2>[[item.metadata.name]]</h2>
        </image-card>
      </template>
    </iron-list>

    <!--<core-list id="images-list" flex height="30" width="420" grid>
    <template is="dom-repeat" items="{{data}}">
      <image-card>
        <iron-image sizing="cover" src="{{item.thumbnail_url}}" preload></iron-image>
        <h2>{{item.metadata.name}}</h2>
      </image-card>
    </template>
    </core-list>-->
  </paper-header-panel>

  <paper-fab icon="add" style="position: absolute; bottom: 23px; right: 23px;" on-tap="tapAddHandler"></paper-fab>

  <paper-dialog id="details-dialog" transition="core-transition-left">
    <style shim-shadowdom>
      paper-button.warning {
        color: #FF0000;
      }
    </style>

    <h2>{{data.metadata.name}}</h2>
    <div horizontal layout>
      <div vertical layout style="margin-right: 10px;">
        <core-image sizing="contain" width="300" height="225" src="{{data.thumbnail_url}}" style="background:white" preload></core-image>
        <label for="imageFile">Associate a music</label>
        <form id="details-import-music-form">
          <input type="file" id="musicFile" name="musicFile">
        </form>

        <template if="{{data.music_url}}">
          <audio controls="controls" preload="none">
            Your browser does not support the <code>audio</code> element.
            <source src="{{data.music_url}}">
          </audio>
        </template>
      </div>
      <div vertical layout>
        <jsonymer-editor id="meta-json-editor"></jsonymer-editor>
      </div>
    </div>

    <paper-button dialog-dismiss autofocus>Close</paper-button>
    <paper-button dialog-confirm class="warning" on-tap="handleDelete">Delete</paper-button>
    <paper-button dialog-confirm raised on-tap="handleSave">Save</paper-button>

  </paper-dialog>

  <paper-dialog id="import-dialog" transition="core-transition-left">
    <h2>Import new image</h2>
    <form action="" method=post enctype="multipart/form-data">
      <div vertical layout>
        <label for="imageFile">Select an image</label>
        <input type="file" id="imageFile" name="image">
        <label for="imageFile">Select a music (optional)</label>
        <input type="file" id="musicFile" name="musicFile">
      </div>
    </form>
    <paper-button dialog-dismiss autofocus>Cancel</paper-button>
    <paper-button dialog-confirm raised autofocus on-tap="handleUploadImage">Import</paper-button>
  </paper-dialog>

  <paper-dialog id="search-dialog" transition="core-transition-left">
    <h2>Search image</h2>
    <form action="" method=post enctype="multipart/form-data">
      <label for="imageFile">Select an image</label><br />
      <input type="file" id="imageFile" name="image" on-change="handleSearchImage"><br/>
    </form>
    <prism-js language="javascript" inputValue="{{jsonResponse}}"></prism-js>
    <paper-button dialog-dismiss autofocus>Close</paper-button>
  </paper-dialog>

</template>
  <script>
  Polymer({
    is: 'root-element',
    created: function() {
      document.addEventListener('polymer-ready', function() {
        var xhr = document.querySelector("#xhr");

        var ajax = document.querySelector("core-ajax");

        var listScope = document.querySelector('#images-list');
        listScope.scrollTarget = document.querySelector('#hPanel').scroller;
        listScope.addEventListener("core-activate", function(e) {
          var refImage = e.detail.data;
          showDetails(refImage);
        });

        var detailsScope = document.querySelector('#details-template');

        detailsScope.handleSave = function(e) {
          var refImage = this.data;

          // Upload music if provided
          if (this.$.musicFile.files.length > 0) {
            var formData = new FormData();
            formData.append("music", this.$.musicFile.files[0]);

            xhr.request({url: "api/1.0/references/" + refImage.id + "/music", method: "POST", body: formData,
                        callback: function(d) {
                          console.log("Uploaded music: " + d);
                        }});
          }

          var newMeta = detailsScope.$['meta-json-editor'].toJSON(true, true);
          xhr.request({url: "api/1.0/references/" + refImage.id + "/metadata",
                      method: "PUT",
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(newMeta),
                      callback: function(d) {
                        console.log("Saved: " + d);
                        var newImage = JSON.parse(d);
                        if (newImage != undefined) {
                          refImage.metadata = newImage['metadata'];
                          refImage.music_url = newImage['music_url'];
                        }
                      }
                    });
        };

        var showDetails = function(refImage) {
          detailsScope.data = refImage;
          detailsScope.$['meta-json-editor'].obj = refImage.metadata;
          detailsScope.$['details-import-music-form'].reset();
          document.querySelector('#details-dialog').open();
        };

        var importScope = document.querySelector('#import-template');
        importScope.handleUploadImage = function(e) {
          if (this.$.imageFile.files.length > 0) {
            var formData = new FormData();
            formData.append("image", this.$.imageFile.files[0]);
            if (this.$.musicFile.files.length > 0)
              formData.append("music", this.$.musicFile.files[0]);

            xhr.request({url: "api/1.0/references/", method: "POST", body: formData,
                        callback: function(d) {
                          console.log("Uploaded: " + d);
                          ajax.go();
                          importDialog.close();          
                        }});
          }
        };

        var searchScope = document.querySelector('#search-template');
        searchScope.handleSearchImage = function(e) {
          if (this.$.imageFile.files.length > 0) {
            var formData = new FormData();
            formData.append("image", this.$.imageFile.files[0]);
            formData.append("min_score", 0.5);

            xhr.request({url: "api/1.0/search", method: "POST", body: formData,
                        callback: function(d) {
                          console.log("Searched: " + d);
                          searchScope.jsonResponse = d;
                          searchDialog.updateTargetDimensions();
                        }});
          }
        };

      });
    },

    handleResponse: function(e) {
      this.set('data', e.detail.response.images);
    },

    tapSearchHandler: function(e) {
      var searchDialog = this.$['search-dialog'];
      searchDialog.open();
    },

    tapRefreshHandler: function(e) {
      this.$['ajax-reference'].generateRequest();
    },

    tapAddHandler: function(e) {
      var importDialog = this.$['import-dialog'];
      importDialog.open();
    },

    handleDelete: function(e) {
      var refImage = this.data;
      var xhr = this.$.xhr;
      xhr.request({url: "api/1.0/references/" + refImage.id, method: "DELETE",
                  callback: function(d) {
                    console.log("Deleted: " + d);
                    ajax.go();
                  }});
    },
  });
  </script>
</dom-module>
<root-element /> 
</body>
{% endraw %}
</html>